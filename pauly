#!/bin/bash

# Pauly CLI
# Manage your automated AI assistant scripts

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/config.sh" 2>/dev/null || true
source "$SCRIPT_DIR/lib/common.sh" 2>/dev/null || true
source "$SCRIPT_DIR/lib/dev.sh" 2>/dev/null || true

VERSION="1.0.0"
CRON_MARKER="# pauly-job"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# ==========================================
# Helper Functions
# ==========================================

print_header() {
    echo -e "${BOLD}${BLUE}Pauly${NC} v${VERSION}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_info() {
    echo -e "${CYAN}→${NC} $1"
}

# ==========================================
# Commands
# ==========================================

cmd_help() {
    print_header
    echo "Usage: pauly <command> [options]"
    echo ""
    echo "Commands:"
    echo "  ${BOLD}run${NC} <job> [-bg]  Run a job manually (summary, git, research, all)"
    echo "  ${BOLD}dev${NC} [opts]       Autonomous development mode"
    echo "  ${BOLD}status${NC}           Show status of all scheduled jobs"
    echo "  ${BOLD}logs${NC} [job]       View logs (optionally for specific job)"
    echo "  ${BOLD}tail${NC} [job]       Follow logs in real-time"
    echo "  ${BOLD}enable${NC} <job>     Enable a scheduled job"
    echo "  ${BOLD}disable${NC} <job>    Disable a scheduled job"
    echo "  ${BOLD}test-email${NC}       Send a test email"
    echo "  ${BOLD}setup${NC}            Run the Mac Mini setup script"
    echo "  ${BOLD}config${NC}           Configure settings interactively"
    echo "  ${BOLD}config show${NC}      Show current configuration"
    echo "  ${BOLD}version${NC}          Show version"
    echo "  ${BOLD}help${NC}             Show this help message"
    echo ""
    echo "Jobs:"
    echo "  summary    Daily Claude activity summary (5am)"
    echo "  git        Git repository health check (6am)"
    echo "  research   Project competitive analysis (Mondays 7am)"
    echo "  tasks      Check for tasks (GitHub Issues and/or email)"
    echo "  all        Run all jobs sequentially"
    echo ""
    echo "Dev Commands:"
    echo "  pauly dev [n]              Run n iterations of PLAN->EXECUTE->REVIEW->FIX"
    echo "  pauly dev init <idea.md>   Bootstrap project from idea file"
    echo "  pauly dev refresh <notes>  Add tasks from freeform notes"
    echo "  pauly dev task \"desc\"      Run isolated single-task mode"
    echo "  pauly dev status           Show development progress"
    echo ""
    echo "Dev Options:"
    echo "  -n <num>                   Max iterations (default 25)"
    echo "  --branch <name>            Use custom branch name (task mode)"
    echo "  --no-pr                    Skip PR creation (task mode)"
    echo "  -f, --file <file>          Read task from file (task mode)"
    echo ""
    echo "Options:"
    echo "  -bg, --background    Run in background (persists after SSH disconnect)"
    echo ""
    echo "Examples:"
    echo "  pauly run summary          # Run daily summary now"
    echo "  pauly run all -bg          # Run all jobs in background"
    echo "  pauly dev init idea.md     # Start new project from idea"
    echo "  pauly dev 10               # Run 10 dev iterations"
    echo "  pauly dev task \"fix bug\"   # Work on isolated task"
}

cmd_version() {
    echo "pauly v${VERSION}"
}

cmd_status() {
    print_header
    echo -e "${BOLD}Scheduled Jobs:${NC}"
    echo ""

    local current_cron=$(crontab -l 2>/dev/null || echo "")

    # Check each job
    if echo "$current_cron" | grep -q "$CRON_MARKER:summary"; then
        echo -e "  ${GREEN}●${NC} ${BOLD}summary${NC}  - 5:00am daily"
    else
        echo -e "  ${RED}○${NC} ${BOLD}summary${NC}  - 5:00am daily (disabled)"
    fi

    if echo "$current_cron" | grep -q "$CRON_MARKER:git"; then
        echo -e "  ${GREEN}●${NC} ${BOLD}git${NC}      - 6:00am daily"
    else
        echo -e "  ${RED}○${NC} ${BOLD}git${NC}      - 6:00am daily (disabled)"
    fi

    if echo "$current_cron" | grep -q "$CRON_MARKER:research"; then
        echo -e "  ${GREEN}●${NC} ${BOLD}research${NC} - 7:00am Mondays"
    else
        echo -e "  ${RED}○${NC} ${BOLD}research${NC} - 7:00am Mondays (disabled)"
    fi

    if echo "$current_cron" | grep -q "$CRON_MARKER:tasks"; then
        echo -e "  ${GREEN}●${NC} ${BOLD}tasks${NC}    - every 5 minutes"
    else
        echo -e "  ${RED}○${NC} ${BOLD}tasks${NC}    - every 5 minutes (disabled)"
    fi

    echo ""
    echo -e "${BOLD}Recent Activity:${NC}"
    echo ""

    # Show last run time for each job
    for log_name in daily-summary git-health-check project-research; do
        local log_file="$SCRIPT_DIR/logs/${log_name}.log"
        if [ -f "$log_file" ]; then
            local last_run=$(grep -E "^\[" "$log_file" 2>/dev/null | tail -1 | grep -oE '\[.*\]' | tr -d '[]')
            if [ -n "$last_run" ]; then
                echo "  ${log_name}: last run $last_run"
            fi
        fi
    done

    echo ""
    echo -e "${BOLD}Configuration:${NC}"
    if config_exists; then
        echo "  Email:    ${EMAIL:-<not set>}"
        echo "  Projects: ${PROJECTS_DIR:-$HOME/Projects}"
        if [ -n "$HEALTHCHECK_URL" ]; then
            echo "  Healthcheck: configured"
        fi
    else
        print_warning "Not configured (run: pauly config)"
    fi

    echo ""
    echo -e "${BOLD}Task Systems:${NC}"
    if [ -n "$GITHUB_TASKS_REPO" ]; then
        print_success "GitHub Issues: $GITHUB_TASKS_REPO (label: $GITHUB_TASKS_LABEL)"
    else
        echo -e "  ${RED}○${NC} GitHub Issues: not configured"
    fi

    if [ -n "$ALLOWED_SENDERS" ]; then
        print_success "Email tasks: enabled"
    else
        echo -e "  ${RED}○${NC} Email tasks: not configured"
    fi

    echo ""
    echo -e "${BOLD}Email Setup:${NC}"
    if [ -f "$HOME/.msmtprc" ]; then
        if grep -q "YOUR_EMAIL\|YOUR_APP_PASSWORD" "$HOME/.msmtprc" 2>/dev/null; then
            print_warning "SMTP not configured (edit ~/.msmtprc)"
        else
            print_success "SMTP configured"
        fi
    else
        print_warning "SMTP not configured (run: pauly setup)"
    fi
}

cmd_run() {
    local job="$1"
    local background="$2"

    # Check for background flag
    if [ "$background" = "-bg" ] || [ "$background" = "--background" ]; then
        cmd_run_background "$job"
        return
    fi

    case "$job" in
        summary|daily)
            print_info "Running daily summary..."
            "$SCRIPT_DIR/daily-claude-summary.sh"
            ;;
        git|health)
            print_info "Running git health check..."
            "$SCRIPT_DIR/git-health-check.sh"
            ;;
        research|competitive)
            print_info "Running project research..."
            "$SCRIPT_DIR/project-research.sh"
            ;;
        tasks)
            # Run configured task systems
            local ran_any=false

            if [ -n "$GITHUB_TASKS_REPO" ]; then
                print_info "Checking GitHub Issues for tasks..."
                "$SCRIPT_DIR/check-github-tasks.sh"
                ran_any=true
            fi

            if [ -n "$ALLOWED_SENDERS" ]; then
                print_info "Checking email for tasks..."
                "$SCRIPT_DIR/check-email-tasks.sh"
                ran_any=true
            fi

            if [ "$ran_any" = false ]; then
                print_warning "No task systems configured."
                echo "Run 'pauly config' to set up GitHub Issues or email tasks."
            fi
            ;;
        all)
            print_info "Running all jobs..."
            "$SCRIPT_DIR/daily-claude-summary.sh"
            "$SCRIPT_DIR/git-health-check.sh"
            "$SCRIPT_DIR/project-research.sh"
            ;;
        -bg|--background)
            print_error "Please specify a job before -bg flag"
            echo "Example: pauly run all -bg"
            exit 1
            ;;
        "")
            print_error "Please specify a job: summary, git, research, or all"
            exit 1
            ;;
        *)
            print_error "Unknown job: $job"
            echo "Available jobs: summary, git, research, all"
            exit 1
            ;;
    esac
}

cmd_run_background() {
    local job="$1"
    local pid_file="$SCRIPT_DIR/logs/background.pid"
    local bg_log="$SCRIPT_DIR/logs/background.log"

    # Check if already running
    if [ -f "$pid_file" ]; then
        local old_pid=$(cat "$pid_file")
        if kill -0 "$old_pid" 2>/dev/null; then
            print_warning "A background job is already running (PID: $old_pid)"
            echo "View progress: pauly tail"
            echo "Or kill it: kill $old_pid"
            return 1
        fi
    fi

    local scripts=""
    case "$job" in
        summary|daily)
            scripts="$SCRIPT_DIR/daily-claude-summary.sh"
            ;;
        git|health)
            scripts="$SCRIPT_DIR/git-health-check.sh"
            ;;
        research|competitive)
            scripts="$SCRIPT_DIR/project-research.sh"
            ;;
        all)
            scripts="$SCRIPT_DIR/daily-claude-summary.sh $SCRIPT_DIR/git-health-check.sh $SCRIPT_DIR/project-research.sh"
            ;;
        *)
            print_error "Unknown job: $job"
            exit 1
            ;;
    esac

    # Run in background with nohup
    (
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Background job started: $job" >> "$bg_log"
        for script in $scripts; do
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Running: $(basename "$script")" >> "$bg_log"
            "$script" >> "$bg_log" 2>&1
        done
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Background job completed: $job" >> "$bg_log"
        rm -f "$pid_file"
    ) &

    local bg_pid=$!
    echo "$bg_pid" > "$pid_file"
    disown "$bg_pid"

    print_success "Started $job in background (PID: $bg_pid)"
    echo ""
    echo "The job will continue running after you disconnect."
    echo ""
    echo "Monitor progress:"
    echo "  pauly tail           # Follow logs live"
    echo "  pauly logs           # View recent logs"
    echo "  kill $bg_pid                # Stop the job"
}

cmd_tail() {
    local job="$1"
    local log_file=""

    case "$job" in
        summary|daily)
            log_file="$SCRIPT_DIR/logs/daily-summary.log"
            ;;
        git|health)
            log_file="$SCRIPT_DIR/logs/git-health-check.log"
            ;;
        research|competitive)
            log_file="$SCRIPT_DIR/logs/project-research.log"
            ;;
        ""|all)
            log_file="$SCRIPT_DIR/logs/background.log"
            ;;
        *)
            print_error "Unknown job: $job"
            exit 1
            ;;
    esac

    if [ -f "$log_file" ]; then
        print_info "Following $log_file (Ctrl+C to stop)"
        tail -f "$log_file"
    else
        print_warning "No logs found at $log_file"
    fi
}

cmd_logs() {
    local job="$1"
    local log_file=""

    case "$job" in
        summary|daily|"")
            log_file="$SCRIPT_DIR/logs/daily-summary.log"
            [ -z "$job" ] && log_file=""  # Show all if no job specified
            ;;
        git|health)
            log_file="$SCRIPT_DIR/logs/git-health-check.log"
            ;;
        research|competitive)
            log_file="$SCRIPT_DIR/logs/project-research.log"
            ;;
        *)
            print_error "Unknown job: $job"
            exit 1
            ;;
    esac

    if [ -n "$log_file" ]; then
        if [ -f "$log_file" ]; then
            echo -e "${BOLD}Logs: $log_file${NC}"
            echo ""
            tail -100 "$log_file"
        else
            print_warning "No logs found at $log_file"
        fi
    else
        # Show all logs
        echo -e "${BOLD}All Logs:${NC}"
        echo ""
        for log in "$SCRIPT_DIR/logs"/*.log; do
            if [ -f "$log" ]; then
                echo -e "${CYAN}=== $(basename "$log") ===${NC}"
                tail -20 "$log"
                echo ""
            fi
        done
    fi
}

cmd_enable() {
    local job="$1"
    local cron_schedule=""
    local script_path=""

    case "$job" in
        summary|daily)
            job="summary"
            cron_schedule="0 5 * * *"  # 5am daily
            script_path="$SCRIPT_DIR/daily-claude-summary.sh"
            ;;
        git|health)
            job="git"
            cron_schedule="0 6 * * *"  # 6am daily
            script_path="$SCRIPT_DIR/git-health-check.sh"
            ;;
        research|competitive)
            job="research"
            cron_schedule="0 7 * * 1"  # 7am Mondays
            script_path="$SCRIPT_DIR/project-research.sh"
            ;;
        tasks)
            job="tasks"
            cron_schedule="*/5 * * * *"  # Every 5 minutes
            # Use a wrapper that runs both configured task systems
            script_path="$SCRIPT_DIR/pauly run tasks"
            ;;
        all)
            cmd_enable "summary"
            cmd_enable "git"
            cmd_enable "research"
            return
            ;;
        "")
            print_error "Please specify a job: summary, git, research, or all"
            exit 1
            ;;
        *)
            print_error "Unknown job: $job"
            exit 1
            ;;
    esac

    # Get current crontab
    local current_cron=$(crontab -l 2>/dev/null || echo "")

    # Check if already enabled
    if echo "$current_cron" | grep -q "$CRON_MARKER:$job"; then
        print_warning "$job is already enabled"
        return
    fi

    # Add new cron entry
    local new_entry="$cron_schedule $script_path >> $SCRIPT_DIR/logs/cron.log 2>&1 $CRON_MARKER:$job"

    if [ -z "$current_cron" ]; then
        echo "$new_entry" | crontab -
    else
        (echo "$current_cron"; echo "$new_entry") | crontab -
    fi

    print_success "Enabled $job ($cron_schedule)"
}

cmd_disable() {
    local job="$1"

    case "$job" in
        summary|daily)
            job="summary"
            ;;
        git|health)
            job="git"
            ;;
        research|competitive)
            job="research"
            ;;
        tasks|email)
            job="tasks"
            ;;
        all)
            cmd_disable "summary"
            cmd_disable "git"
            cmd_disable "research"
            cmd_disable "tasks"
            return
            ;;
        "")
            print_error "Please specify a job: summary, git, research, or all"
            exit 1
            ;;
        *)
            print_error "Unknown job: $job"
            exit 1
            ;;
    esac

    # Get current crontab
    local current_cron=$(crontab -l 2>/dev/null || echo "")

    # Check if enabled
    if ! echo "$current_cron" | grep -q "$CRON_MARKER:$job"; then
        print_warning "$job is not enabled"
        return
    fi

    # Remove the job
    echo "$current_cron" | grep -v "$CRON_MARKER:$job" | crontab -

    print_success "Disabled $job"
}

cmd_test_email() {
    if [ -z "$EMAIL" ]; then
        print_error "Email not configured. Run 'pauly config' first."
        exit 1
    fi

    print_info "Sending test email to $EMAIL..."

    if echo "This is a test email from your Pauly setup on $(hostname)." | mail -s "Pauly Test - $(date '+%Y-%m-%d %H:%M')" "$EMAIL" 2>/dev/null; then
        print_success "Test email sent to $EMAIL"
    else
        print_error "Failed to send email. Check your ~/.msmtprc configuration."
        exit 1
    fi
}

cmd_setup() {
    print_info "Running setup script..."
    echo "This requires sudo access."
    sudo "$SCRIPT_DIR/setup-mac-mini.sh"
}

cmd_config() {
    local subcommand="$1"

    case "$subcommand" in
        show|view)
            show_config
            ;;
        ""|set|edit)
            run_config_wizard
            ;;
        *)
            print_error "Unknown config command: $subcommand"
            echo "Usage: pauly config [show]"
            exit 1
            ;;
    esac
}

cmd_dev() {
    ensure_claude_dev || exit 1

    local subcommand="${1:-}"
    shift 2>/dev/null || true

    case "$subcommand" in
        init)
            local idea_file="${1:-}"
            if [[ -z "$idea_file" ]]; then
                print_error "Please specify an idea file"
                echo "Usage: pauly dev init <idea.md>"
                exit 1
            fi
            dev_init "$idea_file"
            ;;

        refresh)
            local notes_file="${1:-notes.md}"
            dev_refresh "$notes_file"
            ;;

        task)
            local task_desc=""
            local branch_name=""
            local no_pr=false
            local max_iter=25
            local task_file=""

            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --branch) branch_name="$2"; shift 2 ;;
                    --no-pr) no_pr=true; shift ;;
                    -n) max_iter="$2"; shift 2 ;;
                    -f|--file) task_file="$2"; shift 2 ;;
                    *) task_desc="$1"; shift ;;
                esac
            done

            dev_task "$task_desc" "$branch_name" "$no_pr" "$max_iter" "$task_file"
            ;;

        status|st)
            dev_status
            ;;

        ""|[0-9]*)
            # Default: run main loop
            local max_iter="${subcommand:-25}"
            if [[ "$max_iter" =~ ^[0-9]+$ ]]; then
                dev_loop "$max_iter"
            else
                print_error "Invalid iteration count: $max_iter"
                exit 1
            fi
            ;;

        *)
            # Check if it's a number passed with other args
            if [[ "$subcommand" =~ ^[0-9]+$ ]]; then
                dev_loop "$subcommand"
            else
                print_error "Unknown dev command: $subcommand"
                echo "Run 'pauly dev help' or 'pauly help' for usage"
                exit 1
            fi
            ;;
    esac
}

# ==========================================
# Main
# ==========================================

case "${1:-help}" in
    run)
        cmd_run "$2" "$3"
        ;;
    dev)
        shift
        cmd_dev "$@"
        ;;
    status|st)
        cmd_status
        ;;
    logs|log)
        cmd_logs "$2"
        ;;
    tail|follow)
        cmd_tail "$2"
        ;;
    enable)
        cmd_enable "$2"
        ;;
    disable)
        cmd_disable "$2"
        ;;
    test-email|test)
        cmd_test_email
        ;;
    setup)
        cmd_setup
        ;;
    config|configure)
        cmd_config "$2"
        ;;
    version|--version|-v)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo "Run 'pauly help' for usage."
        exit 1
        ;;
esac
